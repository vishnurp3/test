package com.rbs.risk.cradle.climate.migration.parentquest;

public class ParentQuestTemplateRow {

    private final String modelCode;
    private final long modelVerId;
    private final long questionId;
    private final String questionDescription;
    private final int sectionId;
    private final Long moduleId; // nullable
    private final String hasRemovedInUpperVersions; // nullable
    private final String questionKey; // NEW: used only for internal logic

    public ParentQuestTemplateRow(String modelCode,
                                  long modelVerId,
                                  long questionId,
                                  String questionDescription,
                                  int sectionId,
                                  Long moduleId,
                                  String hasRemovedInUpperVersions,
                                  String questionKey) {
        this.modelCode = modelCode;
        this.modelVerId = modelVerId;
        this.questionId = questionId;
        this.questionDescription = questionDescription;
        this.sectionId = sectionId;
        this.moduleId = moduleId;
        this.hasRemovedInUpperVersions = hasRemovedInUpperVersions;
        this.questionKey = questionKey;
    }

    public String getModelCode() {
        return modelCode;
    }

    public long getModelVerId() {
        return modelVerId;
    }

    public long getQuestionId() {
        return questionId;
    }

    public String getQuestionDescription() {
        return questionDescription;
    }

    public int getSectionId() {
        return sectionId;
    }

    public Long getModuleId() {
        return moduleId;
    }

    public String getHasRemovedInUpperVersions() {
        return hasRemovedInUpperVersions;
    }

    public String getQuestionKey() {
        return questionKey;
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class JdbcParentQuestTemplateRepository implements ParentQuestTemplateRepository {

    private final NamedParameterJdbcTemplate jdbc;

    public JdbcParentQuestTemplateRepository(NamedParameterJdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    @Override
    public List<ParentQuestTemplateRow> fetchTemplateRows(String modelType,
                                                          String modelCode,
                                                          long activeModelVerId,
                                                          List<Long> linkedModelVerIds) {

        String prefix = "CTP".equalsIgnoreCase(modelType) ? "CTP" : "CRS";

        String uiTable = prefix + "_UI_QUEST_HELPLINK_MAP";
        String qTable  = prefix + "_QUESTIONS";
        String moduleMapTable = prefix + "_MODULE_MAP";

        StringBuilder sql = new StringBuilder("""
                SELECT :modelCode AS model_code,
                       m.MODEL_VERSION_ID AS model_ver_id,
                       m.QUESTION_ID       AS question_id,
                       m.DESCRIPTION       AS question_description,
                       m.SECTION_ID        AS section_id,
                       mm.MODULE_ID        AS module_id,
                       m.HAS_REMOVED_IN_UPPER_VERSIONS AS has_removed_in_upper_versions,
                       q.QUESTION_KEY      AS question_key
                  FROM %s m
                  JOIN %s q
                    ON q.QUESTION_ID = m.QUESTION_ID
                  LEFT JOIN (
                        SELECT MODEL_VER_ID,
                               QUESTION_ID,
                               MIN(MODULE_ID) AS MODULE_ID
                          FROM %s
                         WHERE EXPIRY_EVENT_ID = 0
                         GROUP BY MODEL_VER_ID, QUESTION_ID
                  ) mm
                    ON mm.MODEL_VER_ID = m.MODEL_VERSION_ID
                   AND mm.QUESTION_ID  = m.QUESTION_ID
                 WHERE m.EXPIRY_EVENT_ID = 0
                   AND m.REQUIRED_BY_UI = 'Y'
                   AND (
                         m.MODEL_VERSION_ID = :activeId
                """.formatted(uiTable, qTable, moduleMapTable));

        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("modelCode", modelCode)
                .addValue("activeId", activeModelVerId);

        if (linkedModelVerIds != null && !linkedModelVerIds.isEmpty()) {
            sql.append("""
                     OR (m.HAS_REMOVED_IN_UPPER_VERSIONS IS NULL
                         AND m.MODEL_VERSION_ID IN (:linkedIds))
                """);
            params.addValue("linkedIds", linkedModelVerIds);
        }

        sql.append(" )");

        return jdbc.query(sql.toString(), params, (rs, rowNum) ->
                new ParentQuestTemplateRow(
                        rs.getString("model_code"),
                        rs.getLong("model_ver_id"),
                        rs.getLong("question_id"),
                        rs.getString("question_description"),
                        rs.getInt("section_id"),
                        rs.getObject("module_id") != null ? rs.getLong("module_id") : null,
                        rs.getString("has_removed_in_upper_versions"),
                        rs.getString("question_key")
                )
        );
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import com.rbs.risk.cradle.climate.migration.domain.LinkedModelVersionService;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionInfo;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionService;
import com.rbs.risk.cradle.climate.migration.repository.RulesQuestQuestionRepository;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.stream.Collectors;

@Service
public class ParentQuestTemplateServiceImpl implements ParentQuestTemplateService {

    private final ParentQuestTemplateRepository repository;
    private final ModelVersionService modelVersionService;
    private final LinkedModelVersionService linkedModelVersionService;
    private final RulesQuestQuestionRepository rulesQuestQuestionRepository;

    // baseKey -> finalKey mapping (CRS-only)
    private static final Map<String, String> CRS_BASE_TO_FINAL_KEYS = Map.of(
            "inherentTransRiskScore", "finalInherentTransRiskScore",
            "inherentPhyRiskScore", "finalInherentPhyRiskScore",
            "phyRiskAdaptationScore", "finalPhyRiskAdaptationScore",
            "transitionRiskAbatementScore", "finalTransitionRiskAbatementScore"
    );

    public ParentQuestTemplateServiceImpl(ParentQuestTemplateRepository repository,
                                          ModelVersionService modelVersionService,
                                          LinkedModelVersionService linkedModelVersionService,
                                          RulesQuestQuestionRepository rulesQuestQuestionRepository) {
        this.repository = repository;
        this.modelVersionService = modelVersionService;
        this.linkedModelVersionService = linkedModelVersionService;
        this.rulesQuestQuestionRepository = rulesQuestQuestionRepository;
    }

    @Override
    public List<ParentQuestTemplateRow> buildTemplateRows(String modelType, String modelCode) {

        // 1. Grab version info (active id etc.)
        // If your ModelVersionService requires an UpgradeType, you can add a dedicated
        // method like getCurrentModelVersionInfo(modelCode) and call that instead.
        ModelVersionInfo info =
                modelVersionService.computeModelVersionInfo(modelCode, /* upgradeType */ null);

        long activeId = info.getActiveModelVerId();
        List<Long> linkedIds = linkedModelVersionService.findLinkedModelVerIds(activeId);

        // 2. Fetch base rows
        List<ParentQuestTemplateRow> baseRows =
                repository.fetchTemplateRows(modelType, modelCode, activeId, linkedIds);

        // 3. Apply section 5 -> (3,4) duplication
        List<ParentQuestTemplateRow> expanded = new ArrayList<>();

        for (ParentQuestTemplateRow row : baseRows) {
            if (row.getSectionId() == 5) {
                expanded.add(new ParentQuestTemplateRow(
                        row.getModelCode(),
                        row.getModelVerId(),
                        row.getQuestionId(),
                        row.getQuestionDescription(),
                        3,
                        row.getModuleId(),
                        row.getHasRemovedInUpperVersions(),
                        row.getQuestionKey()
                ));
                expanded.add(new ParentQuestTemplateRow(
                        row.getModelCode(),
                        row.getModelVerId(),
                        row.getQuestionId(),
                        row.getQuestionDescription(),
                        4,
                        row.getModuleId(),
                        row.getHasRemovedInUpperVersions(),
                        row.getQuestionKey()
                ));
            } else {
                expanded.add(row);
            }
        }

        // 4. CRS-only: add "final..." question rows (section 4, module 111)
        List<ParentQuestTemplateRow> withFinals = "CRS".equalsIgnoreCase(modelType)
                ? addCrsFinalRows(expanded)
                : expanded;

        // 5. Sort rows: section, module, description
        withFinals.sort(Comparator
                .comparingInt(ParentQuestTemplateRow::getSectionId)
                .thenComparing(row -> row.getModuleId() == null ? Long.MAX_VALUE : row.getModuleId())
                .thenComparing(row -> row.getQuestionDescription() == null ? "" : row.getQuestionDescription()));

        return withFinals;
    }

    private List<ParentQuestTemplateRow> addCrsFinalRows(List<ParentQuestTemplateRow> rows) {

        // Which base keys are present among rows?
        Map<String, ParentQuestTemplateRow> baseKeyToRepresentativeRow = rows.stream()
                .filter(r -> r.getQuestionKey() != null)
                .filter(r -> CRS_BASE_TO_FINAL_KEYS.containsKey(r.getQuestionKey()))
                .collect(Collectors.toMap(
                        ParentQuestTemplateRow::getQuestionKey,
                        r -> r,
                        (r1, r2) -> r1 // keep first if duplicate
                ));

        if (baseKeyToRepresentativeRow.isEmpty()) {
            return rows;
        }

        // Find final keys & IDs from CRS_QUESTIONS via existing repository
        List<String> finalKeys = baseKeyToRepresentativeRow.keySet().stream()
                .map(CRS_BASE_TO_FINAL_KEYS::get)
                .distinct()
                .toList();

        var keyAndIds = rulesQuestQuestionRepository.findQuestionsByKeys("CRS", finalKeys);

        Map<String, Long> finalKeyToId = keyAndIds.stream()
                .collect(Collectors.toMap(
                        RulesQuestQuestionRepository.QuestionKeyAndId::getQuestionKey,
                        RulesQuestQuestionRepository.QuestionKeyAndId::getQuestionId
                ));

        List<ParentQuestTemplateRow> extraRows = new ArrayList<>();

        for (var entry : baseKeyToRepresentativeRow.entrySet()) {
            String baseKey = entry.getKey();
            ParentQuestTemplateRow baseRow = entry.getValue();

            String finalKey = CRS_BASE_TO_FINAL_KEYS.get(baseKey);
            if (finalKey == null) {
                continue;
            }
            Long finalQuestionId = finalKeyToId.get(finalKey);
            if (finalQuestionId == null) {
                continue; // final question not found in DB
            }

            extraRows.add(new ParentQuestTemplateRow(
                    baseRow.getModelCode(),
                    baseRow.getModelVerId(),
                    finalQuestionId,
                    baseRow.getQuestionDescription(),          // same description as base question
                    4,                                         // breakdown section
                    111L,                                      // hardcoded module id
                    baseRow.getHasRemovedInUpperVersions(),
                    finalKey                                   // questionKey = final... key
            ));
        }

        List<ParentQuestTemplateRow> all = new ArrayList<>(rows);
        all.addAll(extraRows);
        return all;
    }
}
