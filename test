package com.rbs.risk.cradle.climate.migration.generator;

import com.rbs.risk.cradle.climate.migration.domain.GeneratedSqlFile;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionInfo;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionService;
import com.rbs.risk.cradle.climate.migration.domain.SqlGenerationContext;
import com.rbs.risk.cradle.climate.migration.spi.SqlGenerator;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Generates SQL related to:
 *  - inserting the new model version
 *  - expiring the old active version and updating MODEL_TABLE
 *  - rollback logic
 *
 * All SELECT clauses are single-line and have **no aliases** so user can directly
 * copy-paste into the existing merge script manually.
 */
@Component
public class ModelVersionMigrationGenerator implements SqlGenerator {

    private final ModelVersionService modelVersionService;

    public ModelVersionMigrationGenerator(ModelVersionService modelVersionService) {
        this.modelVersionService = modelVersionService;
    }

    @Override
    public List<GeneratedSqlFile> generate(SqlGenerationContext ctx) {

        ModelVersionInfo info =
                modelVersionService.computeModelVersionInfo(ctx.getModelCode(), ctx.getUpgradeType());

        String folder = ctx.getRootOutputFolder() + "/db/Model/CDF/Data";

        List<GeneratedSqlFile> files = new ArrayList<>();
        files.add(buildMergeFile(ctx, info, folder));
        files.add(buildUpdateFile(ctx, info, folder));
        files.add(buildRollbackFile(ctx, info, folder));

        return files;
    }

    // ------------------------------------------------------------
    // MERGE SCRIPT
    // ------------------------------------------------------------
    private GeneratedSqlFile buildMergeFile(SqlGenerationContext ctx,
                                            ModelVersionInfo info,
                                            String folder) {

        String modelCode = ctx.getModelCode();
        long newId = info.getNewModelVerId();
        String newVersion = info.getNewModelVersion();
        long modelId = info.getActiveModelId();
        String modelTable = modelCode + "_MODEL_VALUES";

        // SINGLE-LINE SELECT, NO ALIASES
        String oneLineSelect =
                "SELECT " + newId + ", '" + newVersion + "', " + modelId + ", '" + modelTable + "' FROM DUAL";

        String sql = """
                SET DEFINE OFF;
                MERGE INTO CDF_MODEL_VERSION cmv
                USING
                (
                    %s
                ) x
                ON (x.MODEL_VER_ID = cmv.MODEL_VER_ID)
                WHEN NOT MATCHED THEN
                    INSERT (MODEL_VER_ID, MODEL_VERSION, MODEL_ID, MODEL_TABLE)
                    VALUES (x.MODEL_VER_ID, x.MODEL_VERSION, x.MODEL_ID, x.MODEL_TABLE);
                COMMIT;
                """.formatted(oneLineSelect);

        String fileName = modelCode + "_MODEL_VERSION_MERGE.sql";
        return new GeneratedSqlFile(folder, fileName, sql);
    }

    // ------------------------------------------------------------
    // UPDATE SCRIPT
    // ------------------------------------------------------------
    private GeneratedSqlFile buildUpdateFile(SqlGenerationContext ctx,
                                             ModelVersionInfo info,
                                             String folder) {

        String jira = ctx.getJira();
        String modelCode = ctx.getModelCode();

        long activeId = info.getActiveModelVerId();
        List<Long> oldIds = info.getExistingModelVerIds(); // excludes new one

        String inClause = oldIds.stream()
                .map(String::valueOf)
                .collect(Collectors.joining(", "));

        String oldTable = modelCode + "_MODEL_DATA";
        String newTable = modelCode + "_MODEL_VALUES";

        String sql = """
                -- Expire currently active model version
                UPDATE CDF_MODEL_VERSION
                   SET EXPIRY_EVENT_ID   = CDF_EXPIRY_EVENT_ID_SEQ.nextval,
                       EXPIRY_EVENT_DATE = SYSDATE
                 WHERE MODEL_VER_ID = %d;

                -- Update MODEL_TABLE from %s to %s for all previous versions
                UPDATE CDF_MODEL_VERSION
                   SET MODEL_TABLE = '%s'
                 WHERE MODEL_VER_ID IN (%s);

                COMMIT;
                """.formatted(
                activeId,
                oldTable,
                newTable,
                newTable,
                inClause
        );

        String fileName = "%s_Update_CDF_MODEL_VERSION.sql".formatted(jira);
        return new GeneratedSqlFile(folder, fileName, sql);
    }

    // ------------------------------------------------------------
    // ROLLBACK SCRIPT
    // ------------------------------------------------------------
    private GeneratedSqlFile buildRollbackFile(SqlGenerationContext ctx,
                                               ModelVersionInfo info,
                                               String folder) {

        String jira = ctx.getJira();
        String modelCode = ctx.getModelCode();

        long activeId = info.getActiveModelVerId();
        long newId = info.getNewModelVerId();
        List<Long> oldIds = info.getExistingModelVerIds();

        String inClause = oldIds.stream()
                .map(String::valueOf)
                .collect(Collectors.joining(", "));

        String oldTable = modelCode + "_MODEL_DATA";

        String sql = """
                -- Delete newly inserted model version
                DELETE FROM CDF_MODEL_VERSION
                 WHERE MODEL_VER_ID = %d;

                -- Reset MODEL_TABLE for all previous versions
                UPDATE CDF_MODEL_VERSION
                   SET MODEL_TABLE = '%s'
                 WHERE MODEL_VER_ID IN (%s);

                -- Rollback: un-expire the previously active version
                UPDATE CDF_MODEL_VERSION
                   SET EXPIRY_EVENT_ID   = 0,
                       EXPIRY_EVENT_DATE = TO_DATE('01-JAN-9999','DD-MON-RRRR')
                 WHERE MODEL_VER_ID = %d;

                COMMIT;
                """.formatted(
                newId,
                oldTable,
                inClause,
                activeId
        );

        String fileName = "%s_Rollback_CDF_MODEL_VERSION.sql".formatted(jira);
        return new GeneratedSqlFile(folder, fileName, sql);
    }
}
