private void writeRow(Writer w, List<String> cols) throws IOException {
    List<String> escaped = cols.stream()
            .map(this::escapeCsv)
            .toList();

    w.write(String.join(",", escaped));
    w.write("\n");
}

private String escapeCsv(String value) {
    if (value == null) return "";

    boolean containsSpecial =
            value.contains(",") ||
            value.contains("\"") ||
            value.contains("\n") ||
            value.contains("\r");

    String escaped = value.replace("\"", "\"\"");

    return containsSpecial ? "\"" + escaped + "\"" : escaped;
}
