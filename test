package com.rbs.risk.cradle.climate.migration.generator;

import com.rbs.risk.cradle.climate.migration.domain.GeneratedSqlFile;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionInfo;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionService;
import com.rbs.risk.cradle.climate.migration.domain.SqlGenerationContext;
import com.rbs.risk.cradle.climate.migration.spi.SqlGenerator;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Generates:
 * - MERGE script to insert a new model version row into CDF_MODEL_VERSION
 * - UPDATE script to expire the current active row and update MODEL_TABLE
 * - ROLLBACK script to undo the above
 *
 * This does NOT touch GitLab or any external files; it only returns
 * in-memory "files" that your controller can print as plain text.
 */
@Component
public class ModelVersionMigrationGenerator implements SqlGenerator {

    private final ModelVersionService modelVersionService;

    public ModelVersionMigrationGenerator(ModelVersionService modelVersionService) {
        this.modelVersionService = modelVersionService;
    }

    @Override
    public List<GeneratedSqlFile> generate(SqlGenerationContext ctx) {
        ModelVersionInfo versionInfo =
                modelVersionService.computeModelVersionInfo(ctx.getModelCode(), ctx.getUpgradeType());

        String baseFolder = ctx.getRootOutputFolder() + "/db/Model/CDF/Data";

        List<GeneratedSqlFile> files = new ArrayList<>();
        files.add(buildMergeFile(ctx, versionInfo, baseFolder));
        files.add(buildUpdateFile(ctx, versionInfo, baseFolder));
        files.add(buildRollbackFile(ctx, versionInfo, baseFolder));
        return files;
    }

    private GeneratedSqlFile buildMergeFile(SqlGenerationContext ctx,
                                            ModelVersionInfo info,
                                            String folder) {

        String modelCode = ctx.getModelCode();
        long newId = info.getNewModelVerId();
        String newVersion = info.getNewModelVersion();

        String tableName = modelCode + "_MODEL_VALUES";

        // NOTE:
        // - MODEL_ID is left as a placeholder; you can replace <TODO_MODEL_ID>
        //   with the correct value or derive it later.
        // - You can also UNION ALL more SELECTs manually if needed.
        String sql = """
                SET DEFINE OFF;
                MERGE INTO CDF_MODEL_VERSION cmv
                USING
                (
                    -- TODO: replace <TODO_MODEL_ID> with the correct MODEL_ID
                    SELECT %d MODEL_VER_ID,
                           '%s' MODEL_VERSION,
                           <TODO_MODEL_ID> MODEL_ID,
                           '%s' MODEL_TABLE
                    FROM DUAL
                ) x
                ON (x.MODEL_VER_ID = cmv.MODEL_VER_ID)
                -- Uncomment below update block if you want to update existing rows in UAT, etc.
                --WHEN MATCHED THEN
                --  UPDATE
                --  SET
                --      MODEL_VERSION = x.MODEL_VERSION,
                --      MODEL_ID      = x.MODEL_ID,
                --      MODEL_TABLE   = x.MODEL_TABLE
                WHEN NOT MATCHED THEN
                    INSERT (MODEL_VER_ID, MODEL_VERSION, MODEL_ID, MODEL_TABLE)
                    VALUES (x.MODEL_VER_ID, x.MODEL_VERSION, x.MODEL_ID, x.MODEL_TABLE);
                                
                COMMIT;
                """.formatted(newId, newVersion, tableName);

        String fileName = modelCode + "_MODEL_VERSION_MERGE.sql";
        return new GeneratedSqlFile(folder, fileName, sql);
    }

    private GeneratedSqlFile buildUpdateFile(SqlGenerationContext ctx,
                                             ModelVersionInfo info,
                                             String folder) {

        String jira = ctx.getJira();
        String modelCode = ctx.getModelCode();

        long activeId = info.getActiveModelVerId();
        List<Long> allOldIds = info.getExistingModelVerIds(); // all existing ids (old ones)

        String inClause = allOldIds.stream()
                .map(String::valueOf)
                .collect(Collectors.joining(", "));

        String oldTableName = modelCode + "_MODEL_DATA";
        String newTableName = modelCode + "_MODEL_VALUES";

        // Placeholder for expiry_event_id sequence: you can replace <YOUR_SEQ>.NEXTVAL
        String sql = """
                -- Expire currently active model version
                UPDATE CDF_MODEL_VERSION
                   SET EXPIRY_EVENT_ID   = <YOUR_SEQ>.NEXTVAL,  -- TODO: replace with actual sequence name
                       EXPIRY_EVENT_DATE = SYSDATE
                 WHERE MODEL_VER_ID = %d;
                                
                -- Update MODEL_TABLE from %s to %s for all existing versions (old ones)
                UPDATE CDF_MODEL_VERSION
                   SET MODEL_TABLE = '%s'
                 WHERE MODEL_VER_ID IN (%s);
                                
                COMMIT;
                """.formatted(
                activeId,
                oldTableName,
                newTableName,
                newTableName,
                inClause
        );

        // "Update scripts all should start with the jira name followed by the update and the table name"
        String fileName = "%s_Update_CDF_MODEL_VERSION.sql".formatted(jira);
        return new GeneratedSqlFile(folder, fileName, sql);
    }

    private GeneratedSqlFile buildRollbackFile(SqlGenerationContext ctx,
                                               ModelVersionInfo info,
                                               String folder) {

        String jira = ctx.getJira();
        String modelCode = ctx.getModelCode();

        long activeId = info.getActiveModelVerId();
        long newId = info.getNewModelVerId();
        List<Long> allOldIds = info.getExistingModelVerIds();

        String inClause = allOldIds.stream()
                .map(String::valueOf)
                .collect(Collectors.joining(", "));

        String oldTableName = modelCode + "_MODEL_DATA";

        String sql = """
                -- Rollback: delete newly inserted model version
                DELETE FROM CDF_MODEL_VERSION
                 WHERE MODEL_VER_ID = %d;
                                
                -- Rollback: reset MODEL_TABLE back to %s for all previous versions
                UPDATE CDF_MODEL_VERSION
                   SET MODEL_TABLE = '%s'
                 WHERE MODEL_VER_ID IN (%s);
                                
                -- Rollback: un-expire the previously active model version
                UPDATE CDF_MODEL_VERSION
                   SET EXPIRY_EVENT_ID   = 0,
                       EXPIRY_EVENT_DATE = TO_DATE('01-JAN-99', 'DD-MON-RR')
                 WHERE MODEL_VER_ID = %d;
                                
                COMMIT;
                """.formatted(
                newId,
                oldTableName,
                oldTableName,
                inClause,
                activeId
        );

        String fileName = "%s_Rollback_CDF_MODEL_VERSION.sql".formatted(jira);
        return new GeneratedSqlFile(folder, fileName, sql);
    }
}
