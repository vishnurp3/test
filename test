package com.rbs.risk.cradle.climate.migration.parentquest;

public enum ParentQuestCsvColumn {

    MODEL_CODE("modelCode", "Model Code"),
    MODEL_VER_ID("modelVerId", "Model Version Id"),
    QUESTION_ID("questionId", "Question Id"),
    QUESTION_DESCRIPTION("questionDescription", "Question Description"),
    SECTION_ID("sectionId", "Section Id"),
    MODULE_ID("moduleId", "Module Id"),
    HAS_REMOVED_IN_UPPER_VERSIONS("hasRemovedInUpperVersions", "Has Removed In Upper Versions"),
    IS_PARENT_QUESTION("isParentQuestion", "Is Parent Question (Y/N)"),
    QUESTION_ORDER("questionOrder", "Question Order");

    private final String fieldName;
    private final String headerLabel;

    ParentQuestCsvColumn(String fieldName, String headerLabel) {
        this.fieldName = fieldName;
        this.headerLabel = headerLabel;
    }

    public String getFieldName() {
        return fieldName;
    }

    public String getHeaderLabel() {
        return headerLabel;
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

public class ParentQuestTemplateRow {

    private final String modelCode;
    private final long modelVerId;
    private final long questionId;
    private final String questionDescription;
    private final int sectionId;
    private final Long moduleId; // nullable
    private final String hasRemovedInUpperVersions; // nullable

    public ParentQuestTemplateRow(String modelCode,
                                  long modelVerId,
                                  long questionId,
                                  String questionDescription,
                                  int sectionId,
                                  Long moduleId,
                                  String hasRemovedInUpperVersions) {
        this.modelCode = modelCode;
        this.modelVerId = modelVerId;
        this.questionId = questionId;
        this.questionDescription = questionDescription;
        this.sectionId = sectionId;
        this.moduleId = moduleId;
        this.hasRemovedInUpperVersions = hasRemovedInUpperVersions;
    }

    public String getModelCode() {
        return modelCode;
    }

    public long getModelVerId() {
        return modelVerId;
    }

    public long getQuestionId() {
        return questionId;
    }

    public String getQuestionDescription() {
        return questionDescription;
    }

    public int getSectionId() {
        return sectionId;
    }

    public Long getModuleId() {
        return moduleId;
    }

    public String getHasRemovedInUpperVersions() {
        return hasRemovedInUpperVersions;
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import java.util.List;

public interface ParentQuestTemplateRepository {

    /**
     * Base rows from CRS/CTP_UI_QUEST_HELPLINK_MAP joined with QUESTIONS and MODULE_MAP.
     *
     * @param modelType        "CRS" or "CTP"
     * @param modelCode        model code (for reference, passed through)
     * @param activeModelVerId active model version id
     * @param linkedModelVerIds list of linked version ids (may be empty)
     */
    List<ParentQuestTemplateRow> fetchTemplateRows(String modelType,
                                                   String modelCode,
                                                   long activeModelVerId,
                                                   List<Long> linkedModelVerIds);
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import java.util.List;

public interface ParentQuestTemplateService {

    /**
     * Returns normalized + sorted rows to be written into the CSV template.
     * Handles:
     *  - fetching base rows
     *  - applying section 5 -> (3,4) duplication
     *  - sorting by section, module, description
     */
    List<ParentQuestTemplateRow> buildTemplateRows(String modelType, String modelCode);
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.Collections;
import java.util.List;

@Repository
public class JdbcParentQuestTemplateRepository implements ParentQuestTemplateRepository {

    private final NamedParameterJdbcTemplate jdbc;

    public JdbcParentQuestTemplateRepository(NamedParameterJdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    @Override
    public List<ParentQuestTemplateRow> fetchTemplateRows(String modelType,
                                                          String modelCode,
                                                          long activeModelVerId,
                                                          List<Long> linkedModelVerIds) {

        String prefix = "CTP".equalsIgnoreCase(modelType) ? "CTP" : "CRS";

        String uiTable = prefix + "_UI_QUEST_HELPLINK_MAP";
        String qTable  = prefix + "_QUESTIONS";
        String moduleMapTable = prefix + "_MODULE_MAP";

        StringBuilder sql = new StringBuilder("""
                SELECT :modelCode AS model_code,
                       m.MODEL_VERSION_ID AS model_ver_id,
                       m.QUESTION_ID       AS question_id,
                       m.DESCRIPTION       AS question_description,
                       m.SECTION_ID        AS section_id,
                       mm.MODULE_ID        AS module_id,
                       m.HAS_REMOVED_IN_UPPER_VERSIONS AS has_removed_in_upper_versions
                  FROM %s m
                  JOIN %s q
                    ON q.QUESTION_ID = m.QUESTION_ID
                  LEFT JOIN (
                        SELECT MODEL_VER_ID,
                               QUESTION_ID,
                               MIN(MODULE_ID) AS MODULE_ID
                          FROM %s
                         WHERE EXPIRY_EVENT_ID = 0
                         GROUP BY MODEL_VER_ID, QUESTION_ID
                  ) mm
                    ON mm.MODEL_VER_ID = m.MODEL_VERSION_ID
                   AND mm.QUESTION_ID  = m.QUESTION_ID
                 WHERE m.EXPIRY_EVENT_ID = 0
                   AND m.REQUIRED_BY_UI = 'Y'
                   AND (
                         m.MODEL_VERSION_ID = :activeId
                """.formatted(uiTable, qTable, moduleMapTable));

        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("modelCode", modelCode)
                .addValue("activeId", activeModelVerId);

        if (linkedModelVerIds != null && !linkedModelVerIds.isEmpty()) {
            sql.append("""
                     OR (m.HAS_REMOVED_IN_UPPER_VERSIONS IS NULL
                         AND m.MODEL_VERSION_ID IN (:linkedIds))
                """);
            params.addValue("linkedIds", linkedModelVerIds);
        }

        sql.append(" )");

        // We don't rely on ORDER BY here because we will sort in Java,
        // but you could add a basic order by question_id if you like.

        return jdbc.query(sql.toString(), params, (rs, rowNum) ->
                new ParentQuestTemplateRow(
                        rs.getString("model_code"),
                        rs.getLong("model_ver_id"),
                        rs.getLong("question_id"),
                        rs.getString("question_description"),
                        rs.getInt("section_id"),
                        rs.getObject("module_id") != null ? rs.getLong("module_id") : null,
                        rs.getString("has_removed_in_upper_versions")
                )
        );
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import com.rbs.risk.cradle.climate.migration.domain.LinkedModelVersionService;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionInfo;
import com.rbs.risk.cradle.climate.migration.domain.ModelVersionService;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;

@Service
public class ParentQuestTemplateServiceImpl implements ParentQuestTemplateService {

    private final ParentQuestTemplateRepository repository;
    private final ModelVersionService modelVersionService;
    private final LinkedModelVersionService linkedModelVersionService;

    public ParentQuestTemplateServiceImpl(ParentQuestTemplateRepository repository,
                                          ModelVersionService modelVersionService,
                                          LinkedModelVersionService linkedModelVersionService) {
        this.repository = repository;
        this.modelVersionService = modelVersionService;
        this.linkedModelVersionService = linkedModelVersionService;
    }

    @Override
    public List<ParentQuestTemplateRow> buildTemplateRows(String modelType, String modelCode) {

        // 1. Grab version info (active id etc.)
        ModelVersionInfo info =
                modelVersionService.computeModelVersionInfo(modelCode, /* upgradeType not relevant here */ null);

        long activeId = info.getActiveModelVerId();
        List<Long> linkedIds = linkedModelVersionService.findLinkedModelVerIds(activeId);

        // 2. Fetch base rows
        List<ParentQuestTemplateRow> baseRows =
                repository.fetchTemplateRows(modelType, modelCode, activeId, linkedIds);

        // 3. Apply section 5 -> (3,4) duplication
        List<ParentQuestTemplateRow> expanded = new ArrayList<>();

        for (ParentQuestTemplateRow row : baseRows) {
            if (row.getSectionId() == 5) {
                // create two rows: section 3 and 4
                expanded.add(new ParentQuestTemplateRow(
                        row.getModelCode(),
                        row.getModelVerId(),
                        row.getQuestionId(),
                        row.getQuestionDescription(),
                        3,
                        row.getModuleId(),
                        row.getHasRemovedInUpperVersions()
                ));
                expanded.add(new ParentQuestTemplateRow(
                        row.getModelCode(),
                        row.getModelVerId(),
                        row.getQuestionId(),
                        row.getQuestionDescription(),
                        4,
                        row.getModuleId(),
                        row.getHasRemovedInUpperVersions()
                ));
            } else {
                expanded.add(row);
            }
        }

        // 4. Sort rows: section, module, description
        expanded.sort(Comparator
                .comparingInt(ParentQuestTemplateRow::getSectionId)
                .thenComparing(row -> row.getModuleId() == null ? Long.MAX_VALUE : row.getModuleId())
                .thenComparing(row -> row.getQuestionDescription() == null ? "" : row.getQuestionDescription()));

        return expanded;
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
public class ParentQuestCsvBuilder {

    public String buildCsv(List<ParentQuestTemplateRow> rows) {
        StringBuilder sb = new StringBuilder();

        // Header line using enum to keep mapping in one place
        String header = List.of(ParentQuestCsvColumn.values()).stream()
                .map(ParentQuestCsvColumn::getHeaderLabel)
                .collect(Collectors.joining(","));
        sb.append(header).append("\n");

        // Data rows
        for (ParentQuestTemplateRow row : rows) {
            // Order must match ParentQuestCsvColumn.values()
            sb.append(escape(row.getModelCode())).append(",");
            sb.append(row.getModelVerId()).append(",");
            sb.append(row.getQuestionId()).append(",");
            sb.append(escape(row.getQuestionDescription())).append(",");
            sb.append(row.getSectionId()).append(",");
            sb.append(row.getModuleId() == null ? "" : row.getModuleId()).append(",");
            sb.append(escape(row.getHasRemovedInUpperVersions())).append(",");
            // is_parent_question and question_order left blank for BA
            sb.append("").append(",");
            sb.append("");
            sb.append("\n");
        }

        return sb.toString();
    }

    private String escape(String value) {
        if (value == null) {
            return "";
        }
        String v = value.replace("\"", "\"\"");
        if (v.contains(",") || v.contains("\"") || v.contains("\n") || v.contains("\r")) {
            return "\"" + v + "\"";
        }
        return v;
    }
}
package com.rbs.risk.cradle.climate.migration.parentquest;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.nio.charset.StandardCharsets;
import java.time.LocalDate;

@RestController
@RequestMapping("/api/v1/parent-quest")
@Api(tags = "Parent Quest Map", description = "Endpoints for parent question mapping templates")
public class ParentQuestTemplateController {

    private final ParentQuestTemplateService templateService;
    private final ParentQuestCsvBuilder csvBuilder;

    public ParentQuestTemplateController(ParentQuestTemplateService templateService,
                                         ParentQuestCsvBuilder csvBuilder) {
        this.templateService = templateService;
        this.csvBuilder = csvBuilder;
    }

    @GetMapping(value = "/template", produces = "text/csv")
    @ApiOperation(
            value = "Download Parent Quest Map CSV template",
            notes = "Generates a CSV template for the given model code and model type (CRS/CTP), " +
                    "pre-filling as much information as possible for Business Analysts to complete."
    )
    @ApiResponses({
            @ApiResponse(code = 200, message = "Template generated successfully"),
            @ApiResponse(code = 400, message = "Invalid parameters"),
            @ApiResponse(code = 500, message = "Error while generating template")
    })
    public ResponseEntity<ByteArrayResource> downloadTemplate(
            @ApiParam(value = "Model code (e.g. SRI)", required = true)
            @RequestParam("modelCode") String modelCode,

            @ApiParam(value = "Model type: CRS or CTP", required = true, allowableValues = "CRS, CTP")
            @RequestParam("modelType") String modelType
    ) {

        var rows = templateService.buildTemplateRows(modelType, modelCode);

        String csv = csvBuilder.buildCsv(rows);
        byte[] bytes = csv.getBytes(StandardCharsets.UTF_8);
        ByteArrayResource resource = new ByteArrayResource(bytes);

        String fileName = "ParentQuestTemplate_" + modelType.toUpperCase() + "_" +
                modelCode.toUpperCase() + "_" + LocalDate.now() + ".csv";

        return ResponseEntity
                .ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + fileName + "\"")
                .contentType(new MediaType("text", "csv", StandardCharsets.UTF_8))
                .contentLength(bytes.length)
                .body(resource);
    }
}
