package com.rbs.risk.cradle.climate.migration.calculator.service;

import com.rbs.risk.cradle.climate.migration.calculator.domain.Module;
import com.rbs.risk.cradle.climate.migration.calculator.domain.Question;
import com.rbs.risk.cradle.climate.migration.calculator.domain.Variable;
import com.rbs.risk.cradle.climate.migration.calculator.dto.QuestionVarMappingRow;
import com.rbs.risk.cradle.climate.migration.calculator.dto.StrategyMappingRow;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class CalculatorCsvExportService {

    private final CalculatorModelBuilderService modelBuilderService;

    public String buildStrategyMappingCsv(String modelCode,
                                          String modelVersion) {

        List<Module> modules = modelBuilderService.buildModulesForModel(modelCode, modelVersion);
        List<StrategyMappingRow> rows = buildStrategyMappingRows(modelCode, modelVersion, modules);

        StringBuilder sb = new StringBuilder();
        sb.append("Model Code,Model Version,question,enricher,method,child,commands,weight_factor,type\n");
        for (StrategyMappingRow row : rows) {
            sb.append(escape(row.modelCode())).append(',')
              .append(escape(row.modelVersion())).append(',')
              .append(escape(row.question())).append(',')
              .append(escape(row.enricher())).append(',')
              .append(escape(row.method())).append(',')
              .append(escape(row.child())).append(',')
              .append(escape(row.commands())).append(',')
              .append(escape(row.weightFactor())).append(',')
              .append(escape(row.type())).append('\n');
        }
        return sb.toString();
    }

    public String buildQuestionVarMappingCsv(String modelCode,
                                             String modelVersion) {

        List<Module> modules = modelBuilderService.buildModulesForModel(modelCode, modelVersion);
        List<QuestionVarMappingRow> rows = buildQuestionVarMappingRows(modelCode, modelVersion, modules);

        StringBuilder sb = new StringBuilder();
        sb.append("Model Code,Model Version,Module,Question,Variable Name,Type,prefix,refdataProvider\n");
        for (QuestionVarMappingRow row : rows) {
            sb.append(escape(row.modelCode())).append(',')
              .append(escape(row.modelVersion())).append(',')
              .append(escape(row.moduleKey())).append(',')
              .append(escape(row.questionKey())).append(',')
              .append(escape(row.variableName())).append(',')
              .append(escape(row.type())).append(',')
              .append(escape(row.prefix())).append(',')
              .append(escape(row.refDataProvider())).append('\n');
        }
        return sb.toString();
    }

    public String buildModuleStrategyConfigCsv(String modelCode,
                                               String modelVersion) {

        StringBuilder sb = new StringBuilder();

        appendModuleStrategyLines(sb, modelCode, modelVersion, "crs_tri");
        appendModuleStrategyLines(sb, modelCode, modelVersion, "crs_trm");
        appendModuleStrategyLines(sb, modelCode, modelVersion, "crs_pri");
        appendModuleStrategyLines(sb, modelCode, modelVersion, "crs_prm");

        return sb.toString();
    }

    private List<StrategyMappingRow> buildStrategyMappingRows(String modelCode,
                                                              String modelVersion,
                                                              List<Module> modules) {

        List<StrategyMappingRow> result = new ArrayList<>();
        int moduleIndex = 0;

        for (Module module : modules) {
            moduleIndex++;

            for (Question parent : module.getQuestions()) {
                String baseFactorWeight = moduleIndex + "." + parent.getOrderInModule();
                String childKeys = parent.getChildren().isEmpty()
                        ? "NA"
                        : parent.computeChildQuestionKeys();

                result.add(new StrategyMappingRow(
                        modelCode,
                        modelVersion,
                        parent.getQuestionKey(),
                        "NA",
                        "NA",
                        childKeys,
                        "",
                        baseFactorWeight,
                        "Sector:ALL"
                ));

                char suffixChar = 'a';
                for (Question child : parent.getChildren()) {
                    String suffix = String.valueOf(suffixChar++);
                    String childFactorWeight = baseFactorWeight + suffix;

                    result.add(new StrategyMappingRow(
                            modelCode,
                            modelVersion,
                            child.getQuestionKey(),
                            "NA",
                            "NA",
                            "NA",
                            "",
                            childFactorWeight,
                            "Sector:ALL"
                    ));
                }
            }
        }

        return result;
    }

    private List<QuestionVarMappingRow> buildQuestionVarMappingRows(String modelCode,
                                                                    String modelVersion,
                                                                    List<Module> modules) {

        List<QuestionVarMappingRow> result = new ArrayList<>();

        for (Module module : modules) {
            for (Question parent : module.getQuestions()) {
                for (Variable variable : parent.getVariables()) {
                    result.add(new QuestionVarMappingRow(
                            modelCode,
                            modelVersion,
                            module.getModuleKey(),
                            parent.getQuestionKey(),
                            variable.getVariableName(),
                            "",
                            variable.getPrefix(),
                            "NA"
                    ));
                }

                for (Question child : parent.getChildren()) {
                    for (Variable variable : child.getVariables()) {
                        result.add(new QuestionVarMappingRow(
                                modelCode,
                                modelVersion,
                                module.getModuleKey(),
                                child.getQuestionKey(),
                                variable.getVariableName(),
                                "",
                                variable.getPrefix(),
                                "NA"
                        ));
                    }
                }
            }
        }

        return result;
    }

    private void appendModuleStrategyLines(StringBuilder sb,
                                           String modelCode,
                                           String modelVersion,
                                           String moduleKey) {

        sb.append(modelCode).append(',').append(modelVersion).append(',')
          .append(moduleKey).append(",weight,,NA,NA,module_weight,,\n");
        sb.append(modelCode).append(',').append(modelVersion).append(',')
          .append(moduleKey).append(",weighted,,NA,NA,module_weighted,,\n");
        sb.append(modelCode).append(',').append(modelVersion).append(',')
          .append(moduleKey).append(",calc_sum,,NA,NA,module_score,,\n");
    }

    private String escape(String value) {
        if (value == null) {
            return "";
        }
        if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
            String escaped = value.replace("\"", "\"\"");
            return "\"" + escaped + "\"";
        }
        return value;
    }
}
package com.rbs.risk.cradle.climate.migration.calculator.web;

import com.rbs.risk.cradle.climate.migration.calculator.service.CalculatorCsvExportService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

@RestController
@RequiredArgsConstructor
public class CalculatorCsvExportController {

    private final CalculatorCsvExportService csvExportService;

    @GetMapping("/api/migration/calculator/export")
    public void exportCsvs(@RequestParam String modelCode,
                           @RequestParam String modelVersion,
                           HttpServletResponse response) throws IOException {

        String versionForFileName = modelVersion.replace('.', '_');

        String strategyCsv = csvExportService.buildStrategyMappingCsv(modelCode, modelVersion);
        String questionVarCsv = csvExportService.buildQuestionVarMappingCsv(modelCode, modelVersion);
        String moduleStrategyCsv = csvExportService.buildModuleStrategyConfigCsv(modelCode, modelVersion);

        response.setStatus(HttpServletResponse.SC_OK);
        response.setContentType("application/zip");
        String zipFileName = modelCode + "_" + versionForFileName + "_export.zip";
        response.setHeader(HttpHeaders.CONTENT_DISPOSITION,
                "attachment; filename=\"" + zipFileName + "\"");

        try (ZipOutputStream zos = new ZipOutputStream(response.getOutputStream())) {

            addEntry(zos,
                    modelCode + "_" + versionForFileName + "_strategyMapping.csv",
                    strategyCsv);

            addEntry(zos,
                    modelCode + "_" + versionForFileName + "_questionVarMapping.csv",
                    questionVarCsv);

            addEntry(zos,
                    "module_strategy_config.csv",
                    moduleStrategyCsv);

            zos.finish();
        }
    }

    private void addEntry(ZipOutputStream zos, String fileName, String content) throws IOException {
        ZipEntry entry = new ZipEntry(fileName);
        zos.putNextEntry(entry);
        byte[] bytes = content.getBytes(StandardCharsets.UTF_8);
        zos.write(bytes);
        zos.closeEntry();
    }
}
