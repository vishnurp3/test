package com.rbs.risk.cradle.climate.migration.calculator.repository;

import com.rbs.risk.cradle.climate.migration.calculator.dto.ParentQuestMapRow;
import lombok.RequiredArgsConstructor;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Collections;
import java.util.List;

@Repository
@RequiredArgsConstructor
public class ParentQuestMapRepositoryImpl implements ParentQuestMapRepository {

    private final JdbcTemplate jdbcTemplate;

    private static final RowMapper<ParentQuestMapRow> ROW_MAPPER = new RowMapper<>() {
        @Override
        public ParentQuestMapRow mapRow(ResultSet rs, int rowNum) throws SQLException {
            long modelVerId = rs.getLong("model_version_id");
            long moduleId = rs.getLong("module_id");
            long parentQuestionId = rs.getLong("parent_question_id");
            int questOrder = rs.getInt("quest_order");

            return new ParentQuestMapRow(
                    modelVerId,
                    moduleId,
                    parentQuestionId,
                    questOrder
            );
        }
    };

    @Override
    public List<ParentQuestMapRow> findParentQuestMap(List<Long> modelVerIds) {
        if (modelVerIds == null || modelVerIds.isEmpty()) {
            return Collections.emptyList();
        }

        String placeholders = String.join(", ", Collections.nCopies(modelVerIds.size(), "?"));

        String sql = """
                select model_version_id,
                       module_id,
                       parent_question_id,
                       quest_order
                from crs_parent_quest_map
                where model_version_id in (%s)
                  and section_id = 3
                """.formatted(placeholders);

        Object[] params = modelVerIds.toArray();
        return jdbcTemplate.query(sql, ROW_MAPPER, params);
    }
}
